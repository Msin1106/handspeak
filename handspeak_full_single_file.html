<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>HandSpeak (JS, no‚Äëcv2) ‚Äî Ng√¥n ng·ªØ h√¨nh th·ªÉ ‚Üí Ti·∫øng Vi·ªát</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f1115; --panel:#151923; --ink:#e6e9ef; --muted:#9aa5b1; --acc:#36d399; --ring:#2c3342 }
    *{box-sizing:border-box}
    html, body { margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif }
    a{color:var(--acc); text-decoration:none}
    main { display:flex; flex-direction:column; gap:18px; padding:18px; max-width:1200px; margin:0 auto }
    header{display:flex; gap:16px; align-items:center; justify-content:space-between}
    nav{display:flex; flex-wrap:wrap; gap:8px}
    nav button{background:#1d2330;border:1px solid var(--ring);color:var(--ink);padding:8px 12px;border-radius:8px;cursor:pointer}
    nav button.active{border-color:var(--acc); box-shadow:0 0 0 1px var(--acc) inset}
    section.panel{background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:16px}
    h2{margin:0 0 6px 0; font-size:20px}
    .hint{color:var(--muted); font-size:14px}
    /* Stage (Practice) */
    #stage { position:relative; width:min(96vw,960px); aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 0 0 1px var(--ring) inset; margin:10px 0 }
    #stage video, #stage canvas { position:absolute; inset:0; width:100%; height:100% }
    #banner { position:absolute; left:12px; top:12px; padding:8px 12px; background:rgba(0,0,0,.6); border-radius:10px; font-weight:600; backdrop-filter: blur(6px) }
    #controls { display:flex; flex-wrap:wrap; align-items:center; gap:12px }
    #controls .group{display:flex; align-items:center; gap:8px}
    #vol-val{ color:var(--muted); min-width:46px; text-align:right }
    input[type=range]{ width:180px }
    button, label { background:#1d2330; border:1px solid var(--ring); color:var(--ink); padding:8px 12px; border-radius:8px; cursor:pointer }
    button:hover{ border-color:#3b4358 }
    .primary{ background:var(--acc); color:#0b1712; border-color:#2b8d6b }
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#394050;transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:3px;background:white;transition:.2s;border-radius:50%}
    .switch input:checked + .slider{background:var(--acc)}
    .switch input:checked + .slider:before{transform:translateX(20px)}
    /* Learn cards */
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
    .card{background:#101521;border:1px solid var(--ring); border-radius:10px; padding:12px}
    .card h4{margin:6px 0 4px 0}
    .card .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#1e2637; border:1px solid var(--ring); font-size:12px; margin-right:6px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#1e2637; border:1px solid #2a3346; padding:2px 6px; border-radius:6px}
    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width:900px){ .two-col{grid-template-columns:1fr} }
    img.round{border-radius:10px; border:1px solid var(--ring); width:100%; height:auto}
    .log{background:#0a121c;border:1px solid #172234;border-radius:10px;padding:10px;height:140px;overflow:auto;font-family:ui-monospace, Menlo, Consolas, monospace;color:#bcd}
  </style>

  <!-- ===== MediaPipe (Hands) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
</head>
<body>
<main>
  <header>
    <div>
      <h1 style="margin:0;font-size:22px">üñêÔ∏è HandSpeak ‚Äì Ng√¥n ng·ªØ h√¨nh th·ªÉ ‚Üí Gi·ªçng n√≥i</h1>
      <div class="hint">Demo ch·∫°y tr√™n tr√¨nh duy·ªát: Camera ‚ûú Mediapipe ‚ûú VƒÉn b·∫£n ‚ûú Gi·ªçng n√≥i (TTS). <span class="kbd">no‚Äëcv2</span></div>
    </div>
    <nav>
      <button data-tab="intro" class="active">Gi·ªõi thi·ªáu</button>
      <button data-tab="learn">H·ªçc & Tra c·ª©u</button>
      <button data-tab="practice">Th·ª±c h√†nh</button>
      <button data-tab="impact">√ù nghƒ©a</button>
    </nav>
  </header>

  <!-- ===== Gi·ªõi thi·ªáu ===== -->
  <section class="panel" id="tab-intro">
    <div class="two-col">
      <div>
        <h2>1) Gi·ªõi thi·ªáu</h2>
        <p>HandSpeak l√† demo chuy·ªÉn <b>ng√¥n ng·ªØ h√¨nh th·ªÉ/k√Ω hi·ªáu tay</b> th√†nh <b>vƒÉn b·∫£n v√† gi·ªçng n√≥i ti·∫øng Vi·ªát</b>:
        Camera ‚Üí MediaPipe ‚Üí Ph√¢n lo·∫°i c·ª≠ ch·ªâ ‚Üí C√¢u ‚Üí TTS.</p>
        <ul>
          <li>Ph√°t hi·ªán tay th·ªùi gian th·ª±c b·∫±ng <b>MediaPipe Hands</b>.</li>
          <li>Ph√¢n lo·∫°i 9 c·ª≠ ch·ªâ: üëã WAVE, ‚úã OPEN_PALM/STOP, üëç THUMBS_UP, üëå OK, ‚úåÔ∏è VICTORY, üëä FIST, üëâ POINT, ü§ô SHAKA.</li>
          <li>ƒê·ªçc ti·∫øng Vi·ªát b·∫±ng <b>Web Speech API</b> (∆∞u ti√™n Google/Microsoft Vietnamese voice).</li>
        </ul>
        <div class="hint">*Demo heuristic (ch∆∞a ph·∫£i VSL ƒë·∫ßy ƒë·ªß). C√≥ th·ªÉ thay b·∫±ng model h·ªçc m√°y khi c√≥ d·ªØ li·ªáu.*</div>
      </div>
      <div>
        <img class="round" src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/American_Sign_Language_ASL.svg/640px-American_Sign_Language_ASL.svg.png" alt="B·∫£ng ch·ªØ c√°i (minh h·ªça Wikimedia)">
        <div class="hint" style="margin-top:6px">H√¨nh minh h·ªça (Wikimedia). B·∫°n c√≥ th·ªÉ thay b·∫±ng ·∫£nh c·ªßa b·∫°n.</div>
      </div>
    </div>
  </section>

  <!-- ===== H·ªçc & Tra c·ª©u ===== -->
  <section class="panel" id="tab-learn" hidden>
    <h2>2) H·ªçc & Tra c·ª©u</h2>
    <p>L√†m quen k√Ω hi·ªáu c∆° b·∫£n: ch·ªØ c√°i, s·ªë, v√† c·ª≠ ch·ªâ giao ti·∫øp nhanh.</p>

    <div class="grid">
      <div class="card">
        <h4>2.1 C·ª≠ ch·ªâ giao ti·∫øp nhanh</h4>
        <div style="display:flex; flex-wrap:wrap; gap:8px; margin:6px 0">
          <span class="badge">üëã Xin ch√†o (WAVE)</span>
          <span class="badge">‚úã Ch√†o b·∫°n / m·ªü l√≤ng b√†n tay (OPEN_PALM)</span>
          <span class="badge">‚úã D·ª´ng l·∫°i (STOP)</span>
          <span class="badge">üëç T·ªët l·∫Øm (THUMBS_UP)</span>
          <span class="badge">üëå OK (OK)</span>
          <span class="badge">‚úåÔ∏è Tuy·ªát v·ªùi (VICTORY)</span>
          <span class="badge">üëä Xin l·ªói* (FIST)</span>
          <span class="badge">üëâ Ch·ªâ tay (POINT)</span>
          <span class="badge">ü§ô Ch√†o th√¢n m·∫≠t (SHAKA)</span>
        </div>
        <div class="hint">*M·ªôt s·ªë √Ω nghƒ©a l√† ‚Äúm·∫πo nh·ªõ‚Äù cho demo. VSL chu·∫©n c·∫ßn th√™m ng·ªØ c·∫£nh.</div>
      </div>

      <div class="card">
        <h4>2.2 M·∫πo luy·ªán t·∫≠p</h4>
        <ul>
          <li>ƒê∆∞a tay r√µ trong v√πng camera, n·ªÅn t∆∞∆°ng ph·∫£n.</li>
          <li>Gi·ªØ c·ª≠ ch·ªâ ·ªïn ƒë·ªãnh 0.5‚Äì1 gi√¢y ƒë·ªÉ h·ªá th·ªëng nh·∫≠n ch·∫Øc h∆°n.</li>
          <li>T·∫≠p theo nh√≥m c·ª≠ ch·ªâ v√† ƒë·ªçc to √Ω nghƒ©a.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ===== Th·ª±c h√†nh (camera + TTS) ===== -->
  <section class="panel" id="tab-practice" hidden>
    <h2>3) Th·ª±c h√†nh v·ªõi camera</h2>
    <div class="hint">Ch·∫°y tr√™n HTTPS/localhost. B·∫•m <b>B·∫≠t camera</b> ƒë·ªÉ c·∫•p quy·ªÅn. Khi nh·∫≠n c·ª≠ ch·ªâ, trang s·∫Ω hi·ªÉn th·ªã c√¢u v√† ƒë·ªçc ti·∫øng Vi·ªát.</div>

    <div id="stage">
      <video id="video" class="input_video" playsinline muted></video>
      <canvas id="canvas" class="output_canvas"></canvas>
      <div id="banner">Ch∆∞a b·∫≠t camera</div>
    </div>

    <div id="controls">
      <div class="group">
        <button id="startCam" class="primary">B·∫≠t camera</button>
        <button id="stopCam">T·∫Øt camera</button>
      </div>

      <div class="group">
        <label class="switch"><input type="checkbox" id="toggle-audio" checked /><span class="slider"></span></label>
        <span>B·∫≠t √¢m thanh</span>
      </div>

      <div class="group">
        <button id="vol-dec" title="Gi·∫£m √¢m l∆∞·ª£ng">‚àí</button>
        <input type="range" id="vol" min="0" max="1" step="0.05" value="1">
        <button id="vol-inc" title="TƒÉng √¢m l∆∞·ª£ng">+</button>
        <span id="vol-val">100%</span>
      </div>

      <div class="group">
        <button id="btn-test-voice">Test ti·∫øng n√≥i</button>
        <button id="btn-reset">Reset v·∫´y tay</button>
        <button id="btn-download-log">T·∫£i log CSV</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </section>

  <!-- ===== √ù nghƒ©a ===== -->
  <section class="panel" id="tab-impact" hidden>
    <h2>4) √ù nghƒ©a & t√°c ƒë·ªông</h2>
    <ul>
      <li><b>Gi·∫£m r√†o c·∫£n</b> giao ti·∫øp nh·ªù chuy·ªÉn k√Ω hi·ªáu ‚Üí l·ªùi n√≥i.</li>
      <li><b>D·ªÖ h·ªçc</b>: c√≥ m·ª•c h·ªçc & th·ª±c h√†nh ngay trong tr√¨nh duy·ªát.</li>
      <li><b>Kh·∫£ thi ‚Äì chi ph√≠ th·∫•p</b>: d√πng th∆∞ vi·ªán m√£ ngu·ªìn m·ªü, ch·∫°y tr√™n laptop ph·ªï th√¥ng.</li>
    </ul>
    <p class="hint">Khi c√≥ d·ªØ li·ªáu, c√≥ th·ªÉ hu·∫•n luy·ªán model CNN/TF‚ÄëLite ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c.</p>
  </section>
</main>

<!-- ================= Vietnamese TTS helper (inlined) ================= -->
<script>
(function(){
  const preferredVoiceNames=[
    "Google Vietnamese","Google Ti·∫øng Vi·ªát","Google tieng Viet",
    "Microsoft HoaiMy Online (Natural) - Vietnamese (Vietnam)",
    "Microsoft An Online (Natural) - Vietnamese (Vietnam)",
    "Vietnamese"
  ];
  let cachedVoices=[], viVoices=[];
  function refreshVoices(){
    cachedVoices = window.speechSynthesis ? window.speechSynthesis.getVoices()||[] : [];
    viVoices = cachedVoices.filter(v =>
      (v.lang && (v.lang.toLowerCase()==="vi-vn" || v.lang.toLowerCase().startsWith("vi"))) ||
      (v.name && /viet|vi[e√™]t/i.test(v.name))
    ).sort((a,b)=>{
      const ia=preferredVoiceNames.findIndex(n=>(a.name||"").toLowerCase()===n.toLowerCase());
      const ib=preferredVoiceNames.findIndex(n=>(b.name||"").toLowerCase()===n.toLowerCase());
      const sa=ia===-1?999:ia, sb=ib===-1?999:ib;
      if (sa!==sb) return sa-sb;
      if (!!b.default-!!a.default) return !!b.default-!!a.default;
      return (a.name||"").localeCompare(b.name||"");
    });
  }
  refreshVoices();
  if (typeof speechSynthesis!=="undefined"){ speechSynthesis.onvoiceschanged = refreshVoices; }

  function createUtter(text, opts={}){
    const u=new SpeechSynthesisUtterance(String(text||"").trim()||""); u.lang="vi-VN";
    let chosen=null;
    if (opts.voice){
      chosen=(window.speechSynthesis.getVoices()||[]).find(v=>(v.name||"").toLowerCase()===String(opts.voice).toLowerCase());
    }
    if (!chosen && viVoices.length) chosen=viVoices[0];
    if (chosen) u.voice=chosen;
    u.rate=(typeof opts.rate==="number"?opts.rate:1.0);
    u.pitch=(typeof opts.pitch==="number"?opts.pitch:1.0);
    u.volume=(typeof opts.volume==="number"?opts.volume:1.0);
    return u;
  }

  function speakVi(text, opts={}){
    if (!("speechSynthesis" in window)) return Promise.reject(new Error("SpeechSynthesis unsupported"));
    if (opts.cancelBeforeSpeak) speechSynthesis.cancel();
    const attempt=()=> new Promise((res,rej)=>{ const u=createUtter(text,opts); u.onend=res; u.onerror=e=>rej(e.error||e); speechSynthesis.speak(u); });
    if (!viVoices.length) return new Promise((res,rej)=> setTimeout(()=>attempt().then(res).catch(rej),200));
    return attempt();
  }
  window.speakVi=speakVi;
  window.getVietnameseVoices=()=>viVoices.slice();
  if (typeof window.speak==="function"){ const _s=window.speak; window.speak=(t,o)=>{ try{return speakVi(t,o);}catch(e){return _s(t,o);} }; }
})();
</script>

<!-- ================= Core Logic (Tabs + Practice + Camera + Heuristic) ================= -->
<script>
  // ---------- Tabs ----------
  const tabs = {intro:'tab-intro', learn:'tab-learn', practice:'tab-practice', impact:'tab-impact'};
  document.querySelectorAll('nav button').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('nav button').forEach(b=>b.classList.toggle('active', b===btn));
      const key = btn.dataset.tab;
      for(const k in tabs){ document.getElementById(tabs[k]).hidden = (k!==key); }
    };
  });

  // ---------- Config / Phrases ----------
  const PHRASE_MAP = {
    WAVE:"Xin ch√†o!", OPEN_PALM:"Ch√†o b·∫°n!", STOP:"D·ª´ng l·∫°i!",
    THUMBS_UP:"T·ªët l·∫Øm!", OK:"OK!", VICTORY:"Tuy·ªát v·ªùi!",
    FIST:"Xin l·ªói!", POINT:"·ªû kia!", SHAKA:"K·∫øt n·ªëi nh√©!"
  };
  // Thresholds
  let OK_RATIO_MAX=0.45, V_SEP_MIN=0.12;
  let WAVE_HIST=20, WAVE_AMP_MIN=0.08, WAVE_SIGN_CHANGES_MIN=5;
  let SMOOTHER_K=5, SMOOTHER_REQUIRED=3;
  let COOLDOWN_SEC=1.5;
  let STOP_STABLE_AMP=0.02;

  // ---------- Practice UI ----------
  const videoEl=document.getElementById('video');
  const canvasEl=document.getElementById('canvas');
  const ctx=canvasEl.getContext('2d');
  const bannerEl=document.getElementById('banner');
  const audioToggle=document.getElementById('toggle-audio');
  const btnReset=document.getElementById('btn-reset');
  const btnTest=document.getElementById('btn-test-voice');
  const btnDownload=document.getElementById('btn-download-log');
  const volSlider=document.getElementById('vol');
  const volVal=document.getElementById('vol-val');
  const btnDec=document.getElementById('vol-dec');
  const btnInc=document.getElementById('vol-inc');
  const btnStart=document.getElementById('startCam');
  const btnStop=document.getElementById('stopCam');

  const wristTrail=[]; const centroidHist=[];
  let lastPhrase=null, lastTime=0;
  let smootherBuf=[];
  let currentVolume=1.0;
  const eventLog=[]; // {ts,label,phrase}

  function banner(t){ if (bannerEl) bannerEl.textContent=t }
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)) }
  function applyVolumeUI(){ volVal.textContent = Math.round(currentVolume*100)+"%"; volSlider.value=String(currentVolume); }

  function speakVI(text){
    if(!audioToggle.checked) return;
    try{
      if (window.speakVi) { window.speakVi(text,{ cancelBeforeSpeak:true, volume: currentVolume }); }
      else { const u=new SpeechSynthesisUtterance(text); u.lang='vi-VN'; u.volume=currentVolume; speechSynthesis.cancel(); speechSynthesis.speak(u); }
    }catch(e){ console.warn("SpeechSynthesis:", e); }
  }

  // ---------- Geometry/Heuristic ----------
  function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y) }
  function palmRef(lm){ return dist(lm[0], lm[9]) + 1e-6 }
  function fingersUp(lm, handed){
    const [thumb_tip,thumb_ip]=[lm[4],lm[3]];
    const [idx_tip,idx_pip]=[lm[8],lm[6]];
    const [mid_tip,mid_pip]=[lm[12],lm[10]];
    const [ring_tip,ring_pip]=[lm[16],lm[14]];
    const [pky_tip,pky_pip]=[lm[20],lm[18]];
    const idx_up = idx_tip.y < idx_pip.y;
    const mid_up = mid_tip.y < mid_pip.y;
    const ring_up = ring_tip.y < ring_pip.y;
    const pky_up = pky_tip.y < pky_pip.y;
    let thumb_up;
    if (handed === "Right") thumb_up = thumb_tip.x < thumb_ip.x;
    else if (handed === "Left") thumb_up = thumb_tip.x > thumb_ip.x;
    else thumb_up = thumb_tip.y < lm[2].y;
    return [thumb_up, idx_up, mid_up, ring_up, pky_up];
  }
  function isOK(lm){ return dist(lm[4], lm[8]) / palmRef(lm) < OK_RATIO_MAX }
  function isVictory(up,lm){ return (up[1] && up[2] && !up[3] && !up[4]) && (dist(lm[8], lm[12]) / palmRef(lm) > V_SEP_MIN) }
  function isOpenPalm(up){ return up.filter(Boolean).length >= 4 }
  function isThumbsUp(up,lm){ return up[0] && (up.slice(1).filter(Boolean).length <= 1) && (lm[4].y < lm[0].y) }
  function isFist(up){ return up.filter(Boolean).length === 0 }
  function isPoint(up){ return up[1] && !up[0] && !up[2] && !up[3] && !up[4] }
  function isShaka(up){ return up[0] && up[4] && !up[1] && !up[2] && !up[3] }

  function updateMotion(lm, W, H){
    const cx = lm.reduce((a,p)=>a+p.x,0)/lm.length;
    centroidHist.push(cx); if (centroidHist.length > WAVE_HIST) centroidHist.shift();
    const wx = Math.round(lm[0].x * W), wy = Math.round(lm[0].y * H);
    wristTrail.push([wx,wy]); if (wristTrail.length > WAVE_HIST) wristTrail.shift();
  }
  function waveAmplitude(arr){ if(arr.length<2) return 0; const max=Math.max(...arr), min=Math.min(...arr); return max-min; }
  function isWaving(){
    if (centroidHist.length < 8) return false;
    const diffs=[]; for (let i=1;i<centroidHist.length;i++) diffs.push(centroidHist[i]-centroidHist[i-1]);
    for (let i=0;i<diffs.length;i++) if (Math.abs(diffs[i]) < 0.004) diffs[i] = 0;
    let changes=0; for (let i=1;i<diffs.length;i++) if (Math.sign(diffs[i]) !== Math.sign(diffs[i-1])) changes++;
    const amp = waveAmplitude(centroidHist);
    return amp >= WAVE_AMP_MIN && changes >= WAVE_SIGN_CHANGES_MIN;
  }
  function isStableOpenPalm(){ return waveAmplitude(centroidHist) < STOP_STABLE_AMP }

  function classify(lm, handed){
    if (isOK(lm)) return "OK";
    const up = fingersUp(lm, handed);
    if (isOpenPalm(up) && isWaving()) return "WAVE";
    if (isOpenPalm(up) && isStableOpenPalm()) return "STOP";
    if (isThumbsUp(up,lm)) return "THUMBS_UP";
    if (isOpenPalm(up)) return "OPEN_PALM";
    if (isVictory(up,lm)) return "VICTORY";
    if (isFist(up)) return "FIST";
    if (isPoint(up)) return "POINT";
    if (isShaka(up)) return "SHAKA";
    return null;
  }

  // ---------- MediaPipe callback ----------
  function onResults(results){
    const img = results.image;
    const W = canvasEl.width = img.width;
    const H = canvasEl.height = img.height;
    ctx.save();
    ctx.clearRect(0,0,W,H);
    ctx.drawImage(img,0,0,W,H);

    let phraseToSay=null, lastLabel=null;

    if (results.multiHandLandmarks && results.multiHandLandmarks.length){
      for (let i=0;i<results.multiHandLandmarks.length;i++){
        const lm = results.multiHandLandmarks[i];
        const handed = (results.multiHandedness && results.multiHandedness[i] && results.multiHandedness[i].label) || "Unknown";
        drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:'#00FF88', lineWidth:3});
        drawLandmarks(ctx, lm, {color:'#FFFFFF', lineWidth:1});
        updateMotion(lm, W, H);
        const label = classify(lm, handed);
        // smoother
        smootherBuf.push(label); if (smootherBuf.length > SMOOTHER_K) smootherBuf.shift();
        let stable=null;
        if(label){
          const cnt = smootherBuf.filter(x=>x===label).length;
          if (cnt >= SMOOTHER_REQUIRED) stable = label;
        }
        if (stable){
          const phrase = PHRASE_MAP[stable];
          const now = performance.now()/1000;
          if (phrase !== lastPhrase || (now - lastTime) > COOLDOWN_SEC){
            phraseToSay=phrase; lastPhrase=phrase; lastTime=now; lastLabel=stable;
          }
        }
      }
    }

    // trail
    if (wristTrail.length>=2){
      ctx.beginPath();
      for (let i=0;i<wristTrail.length-1;i++){ const [x1,y1]=wristTrail[i], [x2,y2]=wristTrail[i+1]; ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); }
      ctx.strokeStyle='#00FF00'; ctx.lineWidth=2; ctx.stroke();
    }
    ctx.restore();

    if (phraseToSay){
      banner(phraseToSay);
      speakVI(phraseToSay);
      eventLog.push({ts:new Date().toISOString(), label:lastLabel||"", phrase:phraseToSay});
      const lg=document.getElementById('log');
      if (lg) lg.textContent = `${new Date().toLocaleTimeString()} ‚Äî ${lastLabel||""}: ${phraseToSay}\n` + lg.textContent;
    }
  }

  // ---------- Start/Stop camera with permissions ----------
  let stream=null, hands=null, camRunner=null;
  async function initHands(){
    hands = new Hands({ locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
    hands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.5 });
    hands.onResults(onResults);
  }
  async function startCamera(){
    try{
      if (!window.isSecureContext){ banner("C·∫ßn HTTPS ho·∫∑c localhost ƒë·ªÉ c·∫•p quy·ªÅn camera."); return; }
      banner("Xin quy·ªÅn camera‚Ä¶");
      stream = await navigator.mediaDevices.getUserMedia({ video:{ width:{ideal:960}, height:{ideal:540} }, audio:false });
      videoEl.srcObject = stream;
      if (!hands) await initHands();
      banner("ƒêang kh·ªüi ƒë·ªông m√¥ h√¨nh tay‚Ä¶");
      camRunner = new Camera(videoEl, { onFrame: async()=>{ await hands.send({image: videoEl}); }, width:960, height:540 });
      await camRunner.start();
      banner("S·∫µn s√†ng ‚Äî gi∆° tay ƒë·ªÉ th·ª≠ üëã");
    }catch(err){
      console.error(err);
      let msg="Kh√¥ng m·ªü ƒë∆∞·ª£c camera.";
      if (err && err.name){
        if (err.name==="NotAllowedError" || err.name==="SecurityError") msg="Tr√¨nh duy·ªát ƒë√£ ch·∫∑n quy·ªÅn camera. B·∫•m bi·ªÉu t∆∞·ª£ng üîí tr√™n thanh ƒë·ªãa ch·ªâ ƒë·ªÉ cho ph√©p.";
        else if (err.name==="NotFoundError" || err.name==="OverconstrainedError") msg="Kh√¥ng t√¨m th·∫•y camera. Ki·ªÉm tra thi·∫øt b·ªã/c√†i ƒë·∫∑t camera.";
        else if (err.name==="NotReadableError") msg="Camera ƒëang b·∫≠n b·ªüi ·ª©ng d·ª•ng kh√°c.";
      }
      banner(msg);
    }
  }
  function stopCamera(){
    try{
      if (camRunner && camRunner.stop) camRunner.stop();
      if (stream){ for(const t of stream.getTracks()) t.stop(); stream=null; }
      videoEl.srcObject=null;
      banner("ƒê√£ t·∫Øt camera.");
    }catch(e){ console.warn(e); }
  }

  // ---------- UI events ----------
  document.getElementById('btn-reset').onclick = ()=>{ centroidHist.length=0; banner("ƒê√£ reset chuy·ªÉn ƒë·ªông"); };
  document.getElementById('btn-test-voice').onclick = ()=> speakVI("Xin ch√†o! ƒê√¢y l√† b·∫£n ki·ªÉm tra √¢m thanh.");
  document.getElementById('btn-download-log').onclick = ()=>{
    if(eventLog.length===0){ banner("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i"); return; }
    const rows = [["timestamp","label","phrase"], ...eventLog.map(r=>[r.ts,r.label,r.phrase])];
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
    const url = URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
    const a=document.createElement('a'); a.href=url; a.download="handspeak_log.csv"; a.click(); URL.revokeObjectURL(url);
  };
  function onVolInput(v){ currentVolume = clamp(parseFloat(v||"1"),0,1); applyVolumeUI(); }
  volSlider.addEventListener('input', e=> onVolInput(e.target.value));
  btnDec.addEventListener('click', ()=> onVolInput((currentVolume-0.1).toFixed(2)));
  btnInc.addEventListener('click', ()=> onVolInput((currentVolume+0.1).toFixed(2)));
  btnStart.addEventListener('click', startCamera);
  btnStop.addEventListener('click', stopCamera);

  // ---------- Init (UI only) ----------
  window.addEventListener('DOMContentLoaded', ()=>{
    applyVolumeUI();
    if (!window.isSecureContext) banner("C·∫ßn ch·∫°y tr√™n HTTPS ho·∫∑c localhost ƒë·ªÉ d√πng camera.");
  });
</script>
</body>
</html>
